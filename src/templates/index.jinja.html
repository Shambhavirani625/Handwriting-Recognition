{% extends "base.jinja.html" %}

{% block content %}
<div class="container-fluid vh-100 d-flex flex-column bg-light">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4 shadow-sm">
        <a class="navbar-brand fw-semibold">‚úç Handwriting Recognition</a>

        <div class="navbar-nav ms-auto gap-2">
            <a class="nav-link" data-bs-toggle="offcanvas" href="#history-off-canvas">History</a>
            <a class="nav-link" data-bs-toggle="modal" href="#settingsModal">Settings</a>
        </div>
    </nav>

    <!-- History -->
    <div class="offcanvas offcanvas-start" id="history-off-canvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">OCR History</h5>
            <button class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body" id="historyList">Loading...</div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
                <div class="modal-header">
                    <h5 class="modal-title">Tesseract Settings</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <label class="form-label">PSM</label>
                    <input id="psmInput" type="number" class="form-control mb-3">

                    <label class="form-label">OEM</label>
                    <input id="oemInput" type="number" class="form-control mb-3">

                    <button class="btn btn-primary w-100" onclick="saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Area -->
    <div class="flex-grow-1 d-flex justify-content-center align-items-center">
        <div class="card p-4 shadow-lg border-0 rounded-4 text-center" style="width: 420px;">

            <!-- ================= UPLOAD VIEW ================= -->
            <div id="uploadView">

                <label class="btn btn-primary btn-lg w-100 py-3 mb-3">
                    üì§ Upload Image
                    <input type="file" id="fileInput" hidden accept="image/*">
                </label>

                <div class="dropdown">
                    <button id="languageBtn" class="btn btn-outline-secondary dropdown-toggle w-100"
                        data-bs-toggle="dropdown">
                        Select Language
                    </button>
                    <ul class="dropdown-menu w-100 text-center">
                        <li><a class="dropdown-item" data-value="eng">English</a></li>
                        <li><a class="dropdown-item" data-value="hin">Hindi</a></li>
                    </ul>
                </div>
            </div>

            <!-- ================= RESULT VIEW ================= -->
            <div id="resultView" class="d-none">

                <img id="imagePreview" class="img-fluid rounded mb-3 border" style="max-height: 220px;">

                <textarea id="resultText" class="form-control mb-2" rows="6" readonly></textarea>

                <div class="d-flex gap-2">
                    <button class="btn btn-success w-50" id="copyBtn" onclick="copyText()">
                        üìã Copy Text
                    </button>

                    <button class="btn btn-outline-primary w-50" onclick="resetUI()">
                        üîÅ Re-upload
                    </button>
                </div>
            </div>


        </div>
    </div>
</div>

<script>
    function copyText() {
        const textArea = document.getElementById("resultText");
        const copyBtn = document.getElementById("copyBtn");

        if (!textArea.value.trim()) return;

        navigator.clipboard.writeText(textArea.value)
            .then(() => {
                copyBtn.innerText = "‚úÖ Copied!";
                setTimeout(() => {
                    copyBtn.innerText = "üìã Copy Text";
                }, 1500);
            })
            .catch(() => {
                alert("Copy failed. Please select text manually.");
            });
    }

    let selectedLang = "eng";

    /* -------- Language -------- */
    document.querySelectorAll(".dropdown-item").forEach(item => {
        item.onclick = () => {
            selectedLang = item.dataset.value;
            languageBtn.innerText = item.innerText;

            fetch("/settings", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ lang: selectedLang })
            });
        };
    });

    /* -------- Upload -------- */
    fileInput.addEventListener("change", async () => {
        const file = fileInput.files[0];
        if (!file) return;

        // Preview Image
        imagePreview.src = URL.createObjectURL(file);

        // Switch UI
        uploadView.classList.add("d-none");
        resultView.classList.remove("d-none");
        resultText.value = "Processing...";

        const formData = new FormData();
        formData.append("file", file);

        const res = await fetch("/upload", {
            method: "POST",
            body: formData
        });

        const data = await res.json();
        resultText.value = data.text || "No text detected";
    });

    /* -------- Reset -------- */
    function resetUI() {
        fileInput.value = "";
        resultText.value = "";
        imagePreview.src = "";

        resultView.classList.add("d-none");
        uploadView.classList.remove("d-none");
    }

    /* -------- Settings -------- */
    async function loadSettings() {
        const res = await fetch("/settings");
        const data = await res.json();
        psmInput.value = data.psm;
        oemInput.value = data.oem;
    }

    async function saveSettings() {
        await fetch("/settings", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                psm: Number(psmInput.value),
                oem: Number(oemInput.value)
            })
        });
        alert("Settings updated");
    }

    settingsModal.addEventListener("shown.bs.modal", loadSettings);

    document.getElementById("history-off-canvas")
        .addEventListener("shown.bs.offcanvas", async () => {

            const container = document.getElementById("historyList");
            container.innerHTML = "";

            const res = await fetch("/history");
            const data = await res.json();

            if (!data.length) {
                container.innerHTML = "<p class='text-muted'>No history available</p>";
                return;
            }

            data.forEach(item => {
                const div = document.createElement("div");
                div.className = "mb-3 border-bottom pb-2";
                div.innerHTML = `
            <small class="text-muted">${item.tesseract_config}</small>
            <p class="mb-1">${item.extracted_text.slice(0, 100)}...</p>
        `;
                container.appendChild(div);
            });
        });
</script>

{% endblock %}