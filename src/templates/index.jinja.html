{% extends "base.jinja.html" %}

{% block content %}
<div class="container-fluid vh-100 d-flex flex-column bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4 shadow-sm">
        <a class="navbar-brand fw-semibold">‚úç Handwriting Recognition</a>

        <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav-mini-button">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="nav-mini-button">
            <div class="navbar-nav ms-auto gap-2">
                <a class="nav-link" data-bs-toggle="offcanvas" href="#history-off-canvas">History</a>
                <a class="nav-link" data-bs-toggle="modal" href="#settingsModal">Settings</a>
            </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start" id="history-off-canvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">OCR History</h5>
            <button class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body" id="historyList">
            <div class="text-muted">Loading...</div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
                <div class="modal-header">
                    <h5 class="modal-title">Tesseract Settings</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">PSM</label>
                        <input type="number" id="psmInput" class="form-control" min="0" max="13">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">OEM</label>
                        <input type="number" id="oemInput" class="form-control" min="0" max="3">
                    </div>

                    <button class="btn btn-primary w-100" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 d-flex justify-content-center align-items-center">
        <div class="card p-5 shadow-lg rounded-4 border-0 text-center"
             style="width: 420px;">

            <label class="btn btn-primary btn-lg w-100 py-3 mb-3">
                üì§ Upload Image
                <input type="file" id="fileInput" hidden>
            </label>

            <!-- Language Dropdown -->
            <div class="dropdown mb-3">
                <button id="languageBtn" class="btn btn-outline-secondary dropdown-toggle w-100"
                        data-bs-toggle="dropdown">
                    Select Language
                </button>

                <ul class="dropdown-menu w-100 text-center">
                    <li><a class="dropdown-item" data-value="eng">English</a></li>
                    <li><a class="dropdown-item" data-value="hin">Hindi</a></li>
                </ul>
            </div>

            <textarea id="resultText"
                      class="form-control mt-3"
                      rows="6"
                      placeholder="Extracted text will appear here..."
                      readonly></textarea>
        </div>
    </div>
</div>

<script>
let selectedLang = "eng";

document.querySelectorAll(".dropdown-item").forEach(item => {
    item.addEventListener("click", () => {
        selectedLang = item.dataset.value;
        document.getElementById("languageBtn").innerText = item.innerText;

        fetch("/settings", {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ lang: selectedLang })
        });
    });
});

document.getElementById("fileInput").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    document.getElementById("resultText").value = "Processing...";

    const res = await fetch("/upload", {
        method: "POST",
        body: formData
    });

    const data = await res.json();
    document.getElementById("resultText").value = data.text || "No text detected";
});

document.getElementById("history-off-canvas")
    .addEventListener("shown.bs.offcanvas", async () => {

    const container = document.getElementById("historyList");
    container.innerHTML = "";

    const res = await fetch("/history");
    const data = await res.json();

    if (!data.length) {
        container.innerHTML = "<p class='text-muted'>No history available</p>";
        return;
    }

    data.forEach(item => {
        const div = document.createElement("div");
        div.className = "mb-3 border-bottom pb-2";
        div.innerHTML = `
            <small class="text-muted">${item.tesseract_config}</small>
            <p class="mb-1">${item.extracted_text.slice(0, 100)}...</p>
        `;
        container.appendChild(div);
    });
});

async function loadSettings() {
    const res = await fetch("/settings");
    const data = await res.json();

    document.getElementById("psmInput").value = data.psm;
    document.getElementById("oemInput").value = data.oem;
}

async function saveSettings() {
    const psm = Number(document.getElementById("psmInput").value);
    const oem = Number(document.getElementById("oemInput").value);

    await fetch("/settings", {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ psm, oem })
    });

    alert("Settings updated");
}

document.getElementById("settingsModal")
    .addEventListener("shown.bs.modal", loadSettings);
</script>

{% endblock %}
